<h2>Local organizations</h2>

<%= form_tag("/organizations/search", :method => "get") do %>
    <%= label_tag(:q, "Search Organizations for:") %>
    <%= text_field_tag(:q) %>
    <%= submit_tag "Search", :class => 'btn btn-info' %>
<% end %>

<div id="orgs_scroll" style="height:300px;width:100%;border:1px solid #ccc;overflow:scroll;">
    <div class="table table-bordered">
      <table>
        <div id="organizations">
        </div>
      </table>
    </div>
</div>
<br/>
<div style="width:50%;float:left">
  <%= link_to 'New Organization', new_organization_path %>

</div>

<% content_for :map do %>
    <br/><br/>
    <%= gmaps("map_options" => {"auto_adjust" => false, "auto_zoom" => true, "center_latitude" => 51.5978,
                                "center_longitude" => -0.3370, "zoom" => 12}, "markers" => {"data" => @json}) %>
<% end %>

<script type="text/javascript">
    (function() {
        var page = 1,
        loading = false;
        orgs = $('#orgs_scroll');

        function nearBottomOfPage() {
            return orgs[0].scrollTop + orgs.innerHeight() >= orgs[0].scrollHeight;
        }

        orgs.scroll(function(){
            if (loading) {
                return;
            }

            if(nearBottomOfPage()) {
                loading=true;
                page++;
                $.ajax({
                    url: document.URL + '?test=0&page=' + page,
                    type: 'get',
                    dataType: 'script',
                    success: function() {
                        $(window).sausage('draw');
                        loading=false;
                    }
                });
            }
        });

        $(window).sausage();
    }());

    $(document).ready(function() {
        <% @organizations.each do |organization| %>
            $("#organizations").append('<tr><td><u><%= link_to organization.name, organization %></u><br/><%= smart_truncate(organization.description) %></td></tr>');
        <% end %>
    });
</script>